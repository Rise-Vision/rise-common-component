<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../node_modules/mocha/mocha.js"></script>
  <script src="../../node_modules/chai/chai.js"></script>
  <script src="../../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../../node_modules/sinon/pkg/sinon.js"></script>
</head>
<body>
<script type="text/javascript">
  function createLocalStorageStub() {
    const map = new Map([
      ["https://storage.googleapis.com/risemedialibrary-abc123/test1.jpg", 1591811669657],
      ["https://storage.googleapis.com/risemedialibrary-abc123/test2.jpg", 1591811724512]
    ]);

    localStorage.setItem("rise_files_last_requested", JSON.stringify(Array.from(map)));

    sinon.spy(localStorage, "getItem");
    sinon.spy(localStorage, "setItem");
  }

  function removeLocalStorageStub() {
    localStorage.removeItem("rise_files_last_requested");

    localStorage.getItem.restore();
    localStorage.setItem.restore();
  }
</script>
<script type="module">
  import * as storeFilesModule from '../../src/store-files-mixin.js'

  suite("last requested storage", () => {
    let lastRequestedStorage;

    setup(() => {
      const StoreFiles = storeFilesModule.StoreFilesMixin(class {});
      lastRequestedStorage = new StoreFiles().lastRequestedStorage;

      createLocalStorageStub();
    });

    teardown(() => {
      sinon.restore();
    });

    suite("_getMap", () => {
      test("should return map of last requested data from Local Storage", () => {
        const map = lastRequestedStorage._getMap();

        assert.deepEqual(Array.from(map), [
          ["https://storage.googleapis.com/risemedialibrary-abc123/test1.jpg", 1591811669657],
          ["https://storage.googleapis.com/risemedialibrary-abc123/test2.jpg", 1591811724512]
        ]);
      });

      test("should return empty map if no data available", () => {
        removeLocalStorageStub();

        const map = lastRequestedStorage._getMap();

        assert.deepEqual(Array.from(map), []);
      });
    });

    suite("_saveMap", () => {
      test("should not save if map provided is invalid", () => {
        lastRequestedStorage._saveMap();
        assert.isFalse(localStorage.setItem.called);

        lastRequestedStorage._saveMap("test");
        assert.isFalse(localStorage.setItem.called);

        lastRequestedStorage._saveMap(123);
        assert.isFalse(localStorage.setItem.called);

        lastRequestedStorage._saveMap(["test"]);
        assert.isFalse(localStorage.setItem.called);

        lastRequestedStorage._saveMap(new Map());
        assert.isTrue(localStorage.setItem.called);
      });

      test("should call setItem() of localStorage with correct key and the provided map stringified", () => {
        const map = new Map([
          ["test1", 123],
          ["test2", 456]
        ]);

        lastRequestedStorage._saveMap(map);

        assert.isTrue(localStorage.setItem.calledWith("rise_files_last_requested", JSON.stringify(Array.from(map))));
      });
    });

    suite("save", () => {
      test("should not execute if local storage not supported", () => {
        lastRequestedStorage._isSupported = false;
        sinon.stub(lastRequestedStorage,"_getMap");

        lastRequestedStorage.save("test", 123);

        assert.isFalse(lastRequestedStorage._getMap.called);
      });

      test("should not execute if params are invalid", () => {
        sinon.stub(lastRequestedStorage,"_getMap");

        lastRequestedStorage.save();
        assert.isFalse(lastRequestedStorage._getMap.called);

        lastRequestedStorage.save("test");
        assert.isFalse(lastRequestedStorage._getMap.called);

        lastRequestedStorage.save("test", "test");
        assert.isFalse(lastRequestedStorage._getMap.called);
      });

      test("should save new item of last requested data to Local Storage", () => {
        lastRequestedStorage.save("https://storage.googleapis.com/risemedialibrary-abc123/test3.jpg", 1591816247812);

        assert.deepEqual(Array.from(lastRequestedStorage._getMap()), [
          ["https://storage.googleapis.com/risemedialibrary-abc123/test1.jpg", 1591811669657],
          ["https://storage.googleapis.com/risemedialibrary-abc123/test2.jpg", 1591811724512],
          ["https://storage.googleapis.com/risemedialibrary-abc123/test3.jpg", 1591816247812]
        ]);
      });

      test("should save an updated item of last requested data to Local Storage", () => {
        lastRequestedStorage.save("https://storage.googleapis.com/risemedialibrary-abc123/test2.jpg", 1591816421014);

        assert.deepEqual(Array.from(lastRequestedStorage._getMap()), [
          ["https://storage.googleapis.com/risemedialibrary-abc123/test1.jpg", 1591811669657],
          ["https://storage.googleapis.com/risemedialibrary-abc123/test2.jpg", 1591816421014]
        ]);
      });
    })

  });


</script>
</body>
</html>
